<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏° ‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏´‡∏≤‡∏á‡∏î‡∏á‡∏£‡∏±‡∏ê‡∏£‡∏≤‡∏©‡∏é‡∏£‡πå‡∏≠‡∏∏‡∏õ‡∏ñ‡∏±‡∏°‡∏†‡πå</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ü‡∏≠‡∏ô‡∏ï‡πå Prompt ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ó‡∏∏‡∏Å‡∏≠‡∏á‡∏Ñ‡πå‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö */
        * {
            font-family: 'Prompt', sans-serif;
        }
        
        /* ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏™‡∏µ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ò‡∏µ‡∏° */
        :root {
            --primary: #ff6b6b;
            --primary-light: #ffb8b8;
            --primary-dark: #d14747;
            --white: #ffffff;
            --light-gray: #f8f9fa;
            --gray: #e9ecef;
        }
        
        /* ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏™‡∏µ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏Ç‡∏≠‡∏á body */
        body {
            background-color: var(--light-gray);
        }
        
        /* ‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡∏≠‡∏ô‡πÄ‡∏ó‡∏ô‡πÄ‡∏ô‡∏≠‡∏£‡πå‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô */
        .calendar-container {
            background-color: var(--white);
            border-radius: 1rem;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
        }
        
        /* ‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡πà‡∏ß‡∏ô‡∏´‡∏±‡∏ß‡∏Ç‡∏≠‡∏á‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô */
        .calendar-header {
            background-color: var(--primary);
            color: var(--white);
            border-radius: 1rem 1rem 0 0;
        }
        
        /* ‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏ß‡∏±‡∏ô‡πÉ‡∏ô‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô */
        .calendar-day {
            min-height: 100px;
            transition: all 0.3s ease;
        }
        
        /* ‡∏™‡πÑ‡∏ï‡∏•‡πå‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÇ‡∏Æ‡πÄ‡∏ß‡∏≠‡∏£‡πå‡πÄ‡∏´‡∏ô‡∏∑‡∏≠‡∏ß‡∏±‡∏ô‡πÉ‡∏ô‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô */
        .calendar-day:hover {
            background-color: var(--light-gray);
            transform: translateY(-2px);
        }
        
        /* ‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏° */
        .calendar-day.has-event {
            background-color: var(--primary-light);
            color: var(--primary-dark);
        }
        
        /* ‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡∏∏‡πà‡∏°‡∏´‡∏•‡∏±‡∏Å */
        .btn-primary {
            background-color: var(--primary);
            color: var(--white);
            transition: all 0.3s ease;
        }
        
        /* ‡∏™‡πÑ‡∏ï‡∏•‡πå‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÇ‡∏Æ‡πÄ‡∏ß‡∏≠‡∏£‡πå‡πÄ‡∏´‡∏ô‡∏∑‡∏≠‡∏õ‡∏∏‡πà‡∏°‡∏´‡∏•‡∏±‡∏Å */
        .btn-primary:hover {
            background-color: var(--primary-dark);
            transform: translateY(-2px);
        }
        
        /* ‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡∏∏‡πà‡∏°‡πÅ‡∏ö‡∏ö outline */
        .btn-outline {
            border: 1px solid var(--primary);
            color: var(--primary);
            transition: all 0.3s ease;
        }
        
        /* ‡∏™‡πÑ‡∏ï‡∏•‡πå‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÇ‡∏Æ‡πÄ‡∏ß‡∏≠‡∏£‡πå‡πÄ‡∏´‡∏ô‡∏∑‡∏≠‡∏õ‡∏∏‡πà‡∏°‡πÅ‡∏ö‡∏ö outline */
        .btn-outline:hover {
            background-color: var(--primary-light);
            color: var(--primary-dark);
        }
        
        /* ‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏° */
        .event-item {
            border-left: 4px solid var(--primary);
            transition: all 0.3s ease;
        }
        
        /* ‡∏™‡πÑ‡∏ï‡∏•‡πå‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÇ‡∏Æ‡πÄ‡∏ß‡∏≠‡∏£‡πå‡πÄ‡∏´‡∏ô‡∏∑‡∏≠‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏° */
        .event-item:hover {
            transform: translateX(5px);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        
        /* ‡πÅ‡∏≠‡∏ô‡∏¥‡πÄ‡∏°‡∏ä‡∏±‡∏ô fade-in */
        .fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }
        
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        /* ‡πÅ‡∏≠‡∏ô‡∏¥‡πÄ‡∏°‡∏ä‡∏±‡∏ô bounce */
        .bounce {
            animation: bounce 1s infinite alternate;
        }
        
        @keyframes bounce {
            from {
                transform: translateY(0);
            }
            to {
                transform: translateY(-5px);
            }
        }
        
        /* ‡πÅ‡∏≠‡∏ô‡∏¥‡πÄ‡∏°‡∏ä‡∏±‡∏ô pulse */
        .pulse {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.05);
            }
            100% {
                transform: scale(1);
            }
        }
        
        /* ‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏ó‡πá‡∏ö‡∏ó‡∏µ‡πà active */
        .tab-active {
            background-color: var(--primary);
            color: var(--white);
        }
        
        /* ‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö loader */
        .loader {
            border: 4px solid var(--light-gray);
            border-top: 4px solid var(--primary);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* ‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î */
        .error-message {
            background-color: #ffebeb;
            color: #d14747;
            border: 1px solid #ff6b6b;
            border-radius: 0.5rem;
            padding: 1rem;
        }
    </style>
</head>
<body>
    <div class="container mx-auto px-4 py-8 max-w-7xl">
        <header class="flex flex-col md:flex-row justify-between items-center mb-8 fade-in">
            <div class="flex items-center mb-4 md:mb-0">
                <div class="mr-4 pulse">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 text-red-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                    </svg>
                </div>
                <div>
                    <h1 class="text-2xl md:text-3xl font-bold text-gray-800">‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</h1>
                    <h2 class="text-lg md:text-xl text-gray-600">‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏´‡∏≤‡∏á‡∏î‡∏á‡∏£‡∏±‡∏ê‡∏£‡∏≤‡∏©‡∏é‡∏£‡πå‡∏≠‡∏∏‡∏õ‡∏ñ‡∏±‡∏°‡∏†‡πå üìö</h2>
                </div>
            </div>
            <div class="flex flex-col md:flex-row space-y-2 md:space-y-0 md:space-x-2">
                <button id="refreshBtn" class="btn-primary px-4 py-2 rounded-lg flex items-center justify-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                    </svg>
                    ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä
                </button>
            </div>
        </header>

        <div class="bg-white rounded-lg shadow-md p-4 mb-6 fade-in">
            <div class="flex flex-col md:flex-row justify-between items-center">
                <div class="flex space-x-2 mb-4 md:mb-0">
                    <button id="monthViewBtn" class="tab-active px-4 py-2 rounded-lg">
                        <span class="mr-1">üìÖ</span> ‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô
                    </button>
                    <button id="yearViewBtn" class="btn-outline px-4 py-2 rounded-lg">
                        <span class="mr-1">üìÜ</span> ‡∏£‡∏≤‡∏¢‡∏õ‡∏µ
                    </button>
                </div>
                
                <div class="flex items-center space-x-2">
                    <button id="prevBtn" class="btn-outline p-2 rounded-lg">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                        </svg>
                    </button>
                    <h2 id="currentPeriod" class="text-xl font-semibold px-4"></h2>
                    <button id="nextBtn" class="btn-outline p-2 rounded-lg">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                        </svg>
                    </button>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-lg shadow-md p-4 mb-6 fade-in">
            <h3 class="text-lg font-semibold mb-3">üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</h3>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</label>
                    <input type="text" id="titleFilter" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-300" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°...">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">‡∏ú‡∏π‡πâ‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á</label>
                    <select id="personFilter" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-300">
                        <option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏á‡∏≤‡∏ô</label>
                    <select id="departmentFilter" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-300">
                        <option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
                    </select>
                </div>
            </div>
            <div class="mt-4 flex justify-end">
                <button id="searchBtn" class="btn-primary px-4 py-2 rounded-lg flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                    </svg>
                    ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
                </button>
            </div>
        </div>

        <div id="loadingIndicator" class="flex justify-center items-center py-10 hidden">
            <div class="loader mr-3"></div>
            <p class="text-gray-600">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p>
        </div>

        <div id="errorMessage" class="error-message hidden mb-6">
            <p class="font-semibold">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î:</p>
            <p id="errorText"></p>
        </div>

        <div id="calendarView" class="calendar-container mb-6 fade-in">
            <div class="calendar-header p-4">
                <div class="grid grid-cols-7 text-center font-semibold">
                    <div>‡∏≠‡∏≤</div>
                    <div>‡∏à</div>
                    <div>‡∏≠</div>
                    <div>‡∏û</div>
                    <div>‡∏û‡∏§</div>
                    <div>‡∏®</div>
                    <div>‡∏™</div>
                </div>
            </div>
            <div id="calendarDays" class="grid grid-cols-7 p-2">
                </div>
        </div>

        <div id="yearView" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 mb-6 hidden fade-in">
            </div>

        <div class="bg-white rounded-lg shadow-md p-4 mb-6 fade-in">
            <h3 class="text-lg font-semibold mb-3">üìã ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</h3>
            <div id="eventsList" class="space-y-3">
                </div>
        </div>

        <div id="eventModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
            <div class="bg-white rounded-lg shadow-xl p-6 max-w-lg w-full mx-4 fade-in">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-semibold" id="modalTitle">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</h3>
                    <button id="closeModal" class="text-gray-500 hover:text-gray-700">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>
                <div id="modalContent" class="space-y-3">
                    </div>
                <div class="mt-6 flex justify-end">
                    <button id="closeModalBtn" class="btn-outline px-4 py-2 rounded-lg">‡∏õ‡∏¥‡∏î</button>
                </div>
            </div>
        </div>

        <footer class="text-center text-gray-500 text-sm mt-8 fade-in">
            <p>¬© 2025 ‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏´‡∏≤‡∏á‡∏î‡∏á‡∏£‡∏±‡∏ê‡∏£‡∏≤‡∏©‡∏é‡∏£‡πå‡∏≠‡∏∏‡∏õ‡∏ñ‡∏±‡∏°‡∏†‡πå - ‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏á‡∏≤‡∏ô‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•</p>
        </footer>
    </div>

    <script>
        // Global variables
        let allEvents = []; // Stores all events
        let currentDate = new Date(); // Current date displayed in the calendar
        let currentView = 'month'; // Current view: 'month' or 'year'
        
        // **IMPORTANT:** Replace this URL with the URL of your Web App deployed from your Google Apps Script.
        // Example: 'https://script.google.com/macros/s/YOUR_DEPLOYED_WEB_APP_ID/exec'
        const API_URL = 'https://script.google.com/macros/s/AKfycbz9j_keDQjuL2wcYnJVJhAEYE6tKmVeWVwHsb5mE_o5MoN1f_Mot3LDLACnAmR-uvEmGg/exec';
        
        // Sheet ID and Sheet Name to fetch data from
        const SHEET_ID = '1vMfGpLQc-Iu7O3JGkGXuzlZf0AXEQWv4fX7YOFbHA1E';
        const SHEET_NAME = '68';
        
        // DOM element references
        const monthViewBtn = document.getElementById('monthViewBtn');
        const yearViewBtn = document.getElementById('yearViewBtn');
        const calendarView = document.getElementById('calendarView');
        const yearView = document.getElementById('yearView');
        const calendarDays = document.getElementById('calendarDays');
        const currentPeriod = document.getElementById('currentPeriod');
        const prevBtn = document.getElementById('prevBtn');
        const nextBtn = document.getElementById('nextBtn');
        const eventsList = document.getElementById('eventsList');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const refreshBtn = document.getElementById('refreshBtn');
        const searchBtn = document.getElementById('searchBtn');
        const titleFilter = document.getElementById('titleFilter');
        const personFilter = document.getElementById('personFilter');
        const departmentFilter = document.getElementById('departmentFilter');
        const eventModal = document.getElementById('eventModal');
        const closeModal = document.getElementById('closeModal');
        const closeModalBtn = document.getElementById('closeModalBtn');
        const modalContent = document.getElementById('modalContent');
        const errorMessageDiv = document.getElementById('errorMessage'); 
        const errorText = document.getElementById('errorText'); 

        // Thai month names
        const thaiMonths = [
            '‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°', '‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå', '‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°', '‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô', '‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°', '‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô',
            '‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°', '‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°', '‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô', '‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°', '‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô', '‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°'
        ];

        // Function to determine color based on department
        function getDepartmentColor(department) {
            const departmentColors = {
                '‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏á‡∏≤‡∏ô‡∏ß‡∏¥‡∏ä‡∏≤‡∏Å‡∏≤‡∏£': '#000000', // Black
                '‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏á‡∏≤‡∏ô‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì': '#008000', // Green
                '‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏á‡∏≤‡∏ô‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•': '#800080', // Purple
                '‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏á‡∏≤‡∏ô‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ': '#FFA500', // Orange
                '‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏á‡∏≤‡∏ô‡∏Å‡∏¥‡∏à‡∏Å‡∏≤‡∏£': '#0000FF' // Blue
            };
            // Trim whitespace from the department string before looking up the color
            const trimmedDepartment = department ? department.trim() : '';
            const color = departmentColors[trimmedDepartment] || '#ff6b6b'; 
            console.log(`Department (original): "${department}", Department (trimmed): "${trimmedDepartment}" -> Color: ${color}`); // Log both original and trimmed
            return color;
        }
        
        // Initialize the application
        function init() {
            fetchEvents(); // Fetch event data
            setupEventListeners(); // Set up event listeners
            updateCalendarTitle(); // Update calendar title
        }
        
        // Set up various event listeners
        function setupEventListeners() {
            monthViewBtn.addEventListener('click', () => switchView('month'));
            yearViewBtn.addEventListener('click', () => switchView('year'));
            prevBtn.addEventListener('click', navigatePrevious);
            nextBtn.addEventListener('click', navigateNext);
            refreshBtn.addEventListener('click', fetchEvents);
            searchBtn.addEventListener('click', filterEvents);
            closeModal.addEventListener('click', hideModal);
            closeModalBtn.addEventListener('click', hideModal);
            
            // Hide modal when clicking outside the modal area
            window.addEventListener('click', (e) => {
                if (e.target === eventModal) {
                    hideModal();
                }
            });
            
            // Add Event Listener for Enter key in search input
            titleFilter.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    filterEvents();
                }
            });
        }
        
        // Switch view between month and year
        function switchView(view) {
            currentView = view;
            
            if (view === 'month') {
                monthViewBtn.classList.add('tab-active');
                monthViewBtn.classList.remove('btn-outline');
                yearViewBtn.classList.remove('tab-active');
                yearViewBtn.classList.add('btn-outline');
                calendarView.classList.remove('hidden');
                yearView.classList.add('hidden');
            } else {
                yearViewBtn.classList.add('tab-active');
                yearViewBtn.classList.remove('btn-outline');
                monthViewBtn.classList.remove('tab-active');
                monthViewBtn.classList.add('btn-outline');
                calendarView.classList.add('hidden');
                yearView.classList.remove('hidden');
            }
            
            updateCalendarTitle();
            filterEvents(); // Call filterEvents to apply filters for the new view
        }
        
        // Update calendar title based on view and current date
        function updateCalendarTitle() {
            if (currentView === 'month') {
                currentPeriod.textContent = `${thaiMonths[currentDate.getMonth()]} ${currentDate.getFullYear() + 543}`;
            } else {
                currentPeriod.textContent = `‡∏õ‡∏µ ${currentDate.getFullYear() + 543}`;
            }
        }
        
        // Navigate to previous month/year
        function navigatePrevious() {
            if (currentView === 'month') {
                currentDate = new Date(currentDate.getFullYear(), currentDate.getMonth() - 1, 1);
            } else {
                currentDate = new Date(currentDate.getFullYear() - 1, 0, 1);
            }
            updateCalendarTitle();
            filterEvents(); // Call filterEvents to re-render with new month/year
        }
        
        // Navigate to next month/year
        function navigateNext() {
            if (currentView === 'month') {
                currentDate = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 1);
            } else {
                currentDate = new Date(currentDate.getFullYear() + 1, 0, 1);
            }
            updateCalendarTitle();
            filterEvents(); // Call filterEvents to re-render with new month/year
        }
        
        // Fetch event data from Google Sheets
        function fetchEvents() {
            showLoading(true); // Show loading status
            hideErrorMessage(); // Hide error message before loading new data
            
            fetch(`${API_URL}?sheetId=${SHEET_ID}&sheetName=${SHEET_NAME}`)
                .then(response => {
                    if (!response.ok) {
                        // If response is not OK (e.g., 404, 500), throw an error
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('Raw data received from Google Apps Script:', data);
                    if (data.error) {
                        // If there's an 'error' field in the returned data (from Google Apps Script)
                        throw new Error(data.error);
                    }
                    allEvents = processEvents(data); // Process event data
                    populateFilters(); // Populate filter dropdowns
                    filterEvents(); // Call filterEvents to render initial view with all filters applied
                    showLoading(false); // Hide loading status
                })
                .catch(error => {
                    console.error('Error fetching data:', error);
                    showLoading(false); // Hide loading status
                    showErrorMessage(`‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: ${error.message || error} ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á ‡∏´‡∏£‡∏∑‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö URL ‡∏Ç‡∏≠‡∏á Google Apps Script`);
                });
        }
        
        // Process event data received from the API
        function processEvents(data) {
            return data.map(item => {
                const startDate = parseDate(item['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô']);
                const endDate = item['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î'] ? parseDate(item['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î']) : startDate;
                
                const processedItem = {
                    id: item.id || generateId(), // Use ID from GS or generate new
                    title: item['‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°'] || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°',
                    startDate: startDate,
                    endDate: endDate,
                    time: item['‡πÄ‡∏ß‡∏•‡∏≤'] || '',
                    location: item['‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà'] || '',
                    department: item['‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏á‡∏≤‡∏ô'] || '',
                    person: item['‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö'] || '',
                    details: item['‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î'] || '',
                    additionalInfo: item['‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°'] || '',
                    color: getDepartmentColor(item['‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏á‡∏≤‡∏ô']) // Assign color based on department
                };
                
                // Add more explicit logging for the Date objects' local values
                console.log(`--- Processed event "${processedItem.title}" ---`);
                if (processedItem.startDate) {
                    console.log(`  Original Date String: "${item['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô']}"`);
                    console.log(`  Parsed Start Date (Local Time): ${processedItem.startDate.toLocaleDateString('th-TH', { year: 'numeric', month: 'long', day: 'numeric' })}`);
                    console.log(`  Parsed Start Date (Full Object String): ${processedItem.startDate.toString()}`);
                    console.log(`  Parsed Start Date (ISO UTC Representation from object): ${processedItem.startDate.toISOString()}`);
                }
                if (processedItem.endDate && processedItem.startDate.toDateString() !== processedItem.endDate.toDateString()) {
                    console.log(`  Original End Date String: "${item['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î']}"`);
                    console.log(`  Parsed End Date (Local Time): ${processedItem.endDate.toLocaleDateString('th-TH', { year: 'numeric', month: 'long', day: 'numeric' })}`);
                    console.log(`  Parsed End Date (Full Object String): ${processedItem.endDate.toString()}`);
                    console.log(`  Parsed End Date (ISO UTC Representation from object): ${processedItem.endDate.toISOString()}`);
                }
                console.log(`----------------------------------`);
                
                return processedItem;
            }).filter(event => event.startDate); // Filter out events without a valid start date
        }
        
        // Convert date string to Date object
        function parseDate(dateStr) {
            if (!dateStr) return null;

            console.log(`Attempting to parse date string: "${dateStr}"`);

            // 1. Handle ISO 8601 strings with time and timezone (e.g., "2025-06-01T17:00:00.000Z")
            // This is the most common cause of off-by-one errors due to UTC to local conversion.
            // We create a Date object from the UTC string, then extract its LOCAL date components
            // to create a new Date object representing midnight of that local date.
            const isoDateTimeMatch = dateStr.match(/^(\d{4})-(\d{2})-(\d{2})T\d{2}:\d{2}:\d{2}\.\d{3}Z$/);
            if (isoDateTimeMatch) {
                const utcDate = new Date(dateStr); // Interpret as UTC
                // Get local date components from the UTC date object
                const year = utcDate.getFullYear();
                const month = utcDate.getMonth();
                const day = utcDate.getDate();
                const localDate = new Date(year, month, day); // Create a new local date at midnight
                console.log(`  -> ISO (UTC to Local) match: Original: "${dateStr}". UTC Date object: ${utcDate.toString()}. Created local Date object: ${localDate.toString()} (ISO UTC representation: ${localDate.toISOString()})`);
                return localDate;
            }

            // 2. Handle YYYY-MM-DD strings (without time or Z, which Date constructor treats as local)
            const ymdMatch = dateStr.match(/^(\d{4})-(\d{2})-(\d{2})$/);
            if (ymdMatch) {
                const year = parseInt(ymdMatch[1]);
                const month = parseInt(ymdMatch[2]) - 1;
                const day = parseInt(ymdMatch[3]);
                const localDate = new Date(year, month, day);
                console.log(`  -> YYYY-MM-DD match: Original: "${dateStr}". Created local Date object: ${localDate.toString()}`);
                return localDate;
            }

            // 3. Fallback to other known formats (DD/MM/YYYY, etc.)
            const formats = [
                // DD/MM/YYYY
                str => {
                    const parts = str.split('/');
                    if (parts.length === 3) {
                        let year = parseInt(parts[2]);
                        if (year > 2500) year -= 543; // Adjust for B.E.
                        const d = new Date(year, parseInt(parts[1]) - 1, parseInt(parts[0]));
                        console.log(`  -> DD/MM/YYYY match: ${d.toString()}`);
                        return d;
                    }
                    return null;
                },
                // DD-MM-YYYY
                str => {
                    const parts = str.split('-');
                    if (parts.length === 3) {
                        let year = parseInt(parts[2]);
                        if (year > 2500) year -= 543;
                        const d = new Date(year, parseInt(parts[1]) - 1, parseInt(parts[0]));
                        console.log(`  -> DD-MM-YYYY match: ${d.toString()}`);
                        return d;
                    }
                    return null;
                },
                // MM/DD/YYYY
                str => {
                    const parts = str.split('/');
                    if (parts.length === 3) {
                        let year = parseInt(parts[2]);
                        if (year > 2500) year -= 543;
                        const d = new Date(year, parseInt(parts[0]) - 1, parseInt(parts[1]));
                        console.log(`  -> MM/DD/YYYY match: ${d.toString()}`);
                        return d;
                    }
                    return null;
                }
            ];
            
            for (const format of formats) {
                const date = format(dateStr);
                if (date && !isNaN(date.getTime())) {
                    return date;
                }
            }
            
            // 4. Final fallback for any other string Date can parse.
            const date = new Date(dateStr);
            console.log(`  -> Fallback parse: ${date.toString()}`);
            return !isNaN(date.getTime()) ? date : null;
        }
        
        // Generate random ID
        function generateId() {
            return Math.random().toString(36).substring(2, 15);
        }
        
        // Populate filter dropdowns
        function populateFilters() {
            // Clear existing options, except the first one ("All")
            personFilter.innerHTML = '<option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>';
            departmentFilter.innerHTML = '<option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>';
            
            // Get unique values
            const persons = [...new Set(allEvents.map(event => event.person).filter(Boolean))];
            const departments = [...new Set(allEvents.map(event => event.department).filter(Boolean))];
            
            // Add options to dropdown
            persons.forEach(person => {
                const option = document.createElement('option');
                option.value = person;
                option.textContent = person;
                personFilter.appendChild(option);
            });
            
            departments.forEach(department => {
                const option = document.createElement('option');
                option.value = department;
                option.textContent = department;
                departmentFilter.appendChild(option);
            });
        }
        
        // Filter events based on search criteria and current month/year
        function filterEvents() {
            const title = titleFilter.value.toLowerCase();
            const person = personFilter.value;
            const department = departmentFilter.value;
            
            let filteredEvents = allEvents;
            
            if (title) {
                filteredEvents = filteredEvents.filter(event => 
                    event.title.toLowerCase().includes(title)
                );
            }
            
            if (person) {
                filteredEvents = filteredEvents.filter(event => 
                    event.person && event.person.includes(person)
                );
            }
            
            if (department) {
                filteredEvents = filteredEvents.filter(event => 
                    event.department && event.department.includes(department)
                );
            }

            // Apply month filter if in month view
            if (currentView === 'month') {
                const currentMonth = currentDate.getMonth();
                const currentYear = currentDate.getFullYear();
                filteredEvents = filteredEvents.filter(event => {
                    const eventStart = event.startDate;
                    const eventEnd = event.endDate;

                    // Check if the event starts in the current month/year
                    const startsInCurrentMonth = (eventStart.getFullYear() === currentYear && eventStart.getMonth() === currentMonth);
                    // Check if the event ends in the current month/year
                    const endsInCurrentMonth = (eventEnd.getFullYear() === currentYear && eventEnd.getMonth() === currentMonth);
                    // Check if the event spans across the current month
                    const spansCurrentMonth = (eventStart.getFullYear() < currentYear || (eventStart.getFullYear() === currentYear && eventStart.getMonth() < currentMonth)) &&
                                              (eventEnd.getFullYear() > currentYear || (eventEnd.getFullYear() === currentYear && eventEnd.getMonth() > currentMonth));

                    return startsInCurrentMonth || endsInCurrentMonth || spansCurrentMonth;
                });
            }
            
            renderEventsList(filteredEvents); // Display filtered event list
            
            if (currentView === 'month') {
                renderMonthCalendar(filteredEvents); // Display filtered month calendar
            } else {
                renderYearCalendar(filteredEvents); // Display filtered year calendar
            }
        }
        
        // Display month calendar
        function renderMonthCalendar(events = allEvents) {
            calendarDays.innerHTML = ''; // Clear existing calendar days
            
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            
            // Find the first and last day of the month
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            
            // Find the day of the week for the 1st (0 = Sunday, 6 = Saturday)
            let firstDayOfWeek = firstDay.getDay();
            
            // Create empty cells for days before the 1st of the month
            for (let i = 0; i < firstDayOfWeek; i++) {
                const dayCell = document.createElement('div');
                dayCell.className = 'calendar-day p-2 border border-gray-100';
                calendarDays.appendChild(dayCell);
            }
            
            // Create cells for each day in the month
            for (let day = 1; day <= lastDay.getDate(); day++) {
                const date = new Date(year, month, day);
                // Filter events occurring on this day
                const dayEvents = events.filter(event => {
                    const eventStart = event.startDate; // Already a local Date object
                    const eventEnd = event.endDate; // Already a local Date object

                    // Compare only the date parts (year, month, day)
                    // Ensure that the 'date' (calendar cell date) falls within the event's start and end dates (inclusive)
                    const normalizedEventStart = new Date(eventStart.getFullYear(), eventStart.getMonth(), eventStart.getDate());
                    const normalizedEventEnd = new Date(eventEnd.getFullYear(), eventEnd.getMonth(), eventEnd.getDate());
                    const normalizedCurrentDate = new Date(date.getFullYear(), date.getMonth(), date.getDate());

                    return (normalizedCurrentDate >= normalizedEventStart && normalizedCurrentDate <= normalizedEventEnd);
                });
                
                const dayCell = document.createElement('div');
                dayCell.className = `calendar-day p-2 border border-gray-100 ${dayEvents.length > 0 ? 'has-event' : ''}`;
                
                const dayHeader = document.createElement('div');
                dayHeader.className = 'flex justify-between items-center mb-1';
                
                const dayNumber = document.createElement('span');
                dayNumber.className = 'font-semibold';
                dayNumber.textContent = day;
                
                const eventCount = document.createElement('span');
                if (dayEvents.length > 0) {
                    eventCount.className = 'text-xs bg-red-500 text-white rounded-full px-2 py-0.5';
                    eventCount.textContent = dayEvents.length;
                }
                
                dayHeader.appendChild(dayNumber);
                if (dayEvents.length > 0) {
                    dayHeader.appendChild(eventCount);
                }
                dayCell.appendChild(dayHeader);
                
                // Add event indicators
                if (dayEvents.length > 0) {
                    const eventsListForDay = document.createElement('div');
                    eventsListForDay.className = 'space-y-1 mt-1';
                    
                    // Display up to 2 events, then a "more" indicator
                    const displayEvents = dayEvents.slice(0, 2);
                    displayEvents.forEach(event => {
                        const eventItem = document.createElement('div');
                        eventItem.className = 'text-xs truncate cursor-pointer hover:font-semibold';
                        eventItem.style.borderLeft = `3px solid ${event.color}`; // Use department color
                        eventItem.style.paddingLeft = '4px';
                        eventItem.textContent = event.title; // Display event title
                        eventItem.addEventListener('click', () => showEventDetails(event));
                        eventsListForDay.appendChild(eventItem);
                    });
                    
                    if (dayEvents.length > 2) {
                        const moreIndicator = document.createElement('div');
                        moreIndicator.className = 'text-xs text-center text-gray-500 cursor-pointer hover:underline';
                        moreIndicator.textContent = `+ ‡∏≠‡∏µ‡∏Å ${dayEvents.length - 2} ‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°`;
                        moreIndicator.addEventListener('click', () => {
                            // Filter event list to show only today's events
                            renderEventsList(dayEvents);
                        });
                        eventsListForDay.appendChild(moreIndicator);
                    }
                    
                    dayCell.appendChild(eventsListForDay);
                }
                
                calendarDays.appendChild(dayCell);
            }
        }
        
        // Display year calendar
        function renderYearCalendar(events = allEvents) {
            yearView.innerHTML = ''; // Clear existing months
            
            const year = currentDate.getFullYear();
            
            // Create mini-calendar for each month
            for (let month = 0; month < 12; month++) {
                const monthContainer = document.createElement('div');
                monthContainer.className = 'bg-white rounded-lg shadow-sm p-3 fade-in';
                
                const monthHeader = document.createElement('div');
                monthHeader.className = 'text-center font-semibold mb-2 text-red-500';
                monthHeader.textContent = thaiMonths[month];
                monthContainer.appendChild(monthHeader);
                
                // Create mini-calendar grid
                const calendarGrid = document.createElement('div');
                calendarGrid.className = 'grid grid-cols-7 gap-1 text-center text-xs';
                
                // Add day headers
                const dayHeaders = ['‡∏≠‡∏≤', '‡∏à', '‡∏≠', '‡∏û', '‡∏û‡∏§', '‡∏®', '‡∏™'];
                dayHeaders.forEach(day => {
                    const dayHeader = document.createElement('div');
                    dayHeader.className = 'text-gray-500';
                    dayHeader.textContent = day;
                    calendarGrid.appendChild(dayHeader);
                });
                
                // Find the 1st day of the month
                const firstDay = new Date(year, month, 1);
                const lastDay = new Date(year, month + 1, 0);
                const firstDayOfWeek = firstDay.getDay();
                
                // Add empty cells for days before the 1st
                for (let i = 0; i < firstDayOfWeek; i++) {
                    const emptyCell = document.createElement('div');
                    calendarGrid.appendChild(emptyCell);
                }
                
                // Add cells for each day
                for (let day = 1; day <= lastDay.getDate(); day++) {
                    const date = new Date(year, month, day);
                    // Filter events occurring on this day
                    const dayEvents = events.filter(event => {
                        const eventStart = event.startDate; // Already a local Date object
                        const eventEnd = event.endDate; // Already a local Date object

                        // Compare only the date parts (year, month, day)
                        const normalizedEventStart = new Date(eventStart.getFullYear(), eventStart.getMonth(), eventStart.getDate());
                        const normalizedEventEnd = new Date(eventEnd.getFullYear(), eventEnd.getMonth(), eventEnd.getDate());
                        const normalizedCurrentDate = new Date(date.getFullYear(), date.getMonth(), date.getDate());

                        return (normalizedCurrentDate >= normalizedEventStart && normalizedCurrentDate <= normalizedEventEnd);
                    });
                    
                    const dayCell = document.createElement('div');
                    dayCell.className = `py-1 cursor-pointer ${dayEvents.length > 0 ? 'bg-red-100 rounded-full font-semibold' : ''}`;
                    dayCell.textContent = day;
                    
                    if (dayEvents.length > 0) {
                        dayCell.addEventListener('click', () => {
                            // Set current date to today and switch to month view
                            currentDate = new Date(year, month, day);
                            switchView('month');
                        });
                    }
                    
                    calendarGrid.appendChild(dayCell);
                }
                
                monthContainer.appendChild(calendarGrid);
                
                // Count events for this month
                const monthEvents = events.filter(event => {
                    const eventDate = new Date(event.startDate);
                    return eventDate.getMonth() === month && eventDate.getFullYear() === year;
                });
                
                if (monthEvents.length > 0) {
                    const eventCount = document.createElement('div');
                    eventCount.className = 'text-center text-xs mt-2 text-red-500';
                    eventCount.textContent = `${monthEvents.length} ‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°`;
                    monthContainer.appendChild(eventCount);
                }
                
                yearView.appendChild(monthContainer);
            }
        }
        
        // Display event list
        function renderEventsList(events = allEvents) {
            eventsList.innerHTML = ''; // Clear existing event list
            
            if (events.length === 0) {
                const noEvents = document.createElement('div');
                noEvents.className = 'text-center text-gray-500 py-4';
                noEvents.textContent = '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤';
                eventsList.appendChild(noEvents);
                return;
            }
            
            // Sort events by date
            const sortedEvents = [...events].sort((a, b) => new Date(a.startDate) - new Date(b.startDate));
            
            // Group events by month
            const eventsByMonth = {};
            sortedEvents.forEach(event => {
                const date = event.startDate; // Already a local Date object
                const monthYear = `${thaiMonths[date.getMonth()]} ${date.getFullYear() + 543}`;
                
                if (!eventsByMonth[monthYear]) {
                    eventsByMonth[monthYear] = [];
                }
                
                eventsByMonth[monthYear].push(event);
            });
            
            // Create event list by month
            Object.keys(eventsByMonth).forEach(monthYear => {
                const monthHeader = document.createElement('h4');
                monthHeader.className = 'font-semibold text-red-500 mb-2';
                monthHeader.textContent = monthYear;
                eventsList.appendChild(monthHeader);
                
                const monthEvents = eventsByMonth[monthYear];
                monthEvents.forEach(event => {
                    const eventItem = document.createElement('div');
                    eventItem.className = 'event-item bg-white p-3 rounded-lg shadow-sm mb-3';
                    eventItem.addEventListener('click', () => showEventDetails(event));
                    
                    const eventHeader = document.createElement('div');
                    eventHeader.className = 'flex justify-between items-start';
                    
                    const eventTitle = document.createElement('h5');
                    eventTitle.className = 'font-semibold';
                    eventTitle.textContent = event.title; // Display event title
                    eventTitle.style.color = event.color; // Set color for event title
                    
                    const eventDate = document.createElement('div');
                    eventDate.className = 'text-sm text-gray-500';
                    
                    const startDate = event.startDate; // Already a local Date object
                    const formattedStartDate = `${startDate.getDate()} ${thaiMonths[startDate.getMonth()]} ${startDate.getFullYear() + 543}`;
                    
                    if (event.endDate && startDate.toDateString() !== event.endDate.toDateString()) {
                        const endDate = event.endDate; // Already a local Date object
                        const formattedEndDate = `${endDate.getDate()} ${thaiMonths[endDate.getMonth()]} ${endDate.getFullYear() + 543}`;
                        eventDate.textContent = `${formattedStartDate} - ${formattedEndDate}`;
                    } else {
                        eventDate.textContent = formattedStartDate;
                    }
                    
                    eventHeader.appendChild(eventTitle);
                    eventHeader.appendChild(eventDate);
                    eventItem.appendChild(eventHeader);
                    
                    if (event.department || event.person) {
                        const eventInfo = document.createElement('div');
                        eventInfo.className = 'text-sm mt-1';
                        
                        if (event.department) {
                            const deptSpan = document.createElement('span');
                            deptSpan.className = 'text-red-500 mr-2'; 
                            deptSpan.textContent = `${event.department}`; // Display department
                            deptSpan.style.color = event.color; // Set color for department
                            eventInfo.appendChild(deptSpan);
                        }
                        
                        if (event.person) {
                            const personSpan = document.createElement('span');
                            personSpan.className = 'text-gray-600';
                            personSpan.textContent = `üë§ ${event.person}`; // Display person in charge
                            eventInfo.appendChild(personSpan);
                        }
                        
                        eventItem.appendChild(eventInfo);
                    }
                    
                    eventsList.appendChild(eventItem);
                });
            });
        }
        
        // Show event details in modal
        function showEventDetails(event) {
            modalContent.innerHTML = ''; // Clear existing modal content
            
            // Event title
            const title = document.createElement('h3');
            title.className = 'text-xl font-semibold mb-3';
            title.textContent = event.title;
            title.style.color = event.color; // Set color for event title in modal
            modalContent.appendChild(title);
            
            // Event start date
            const startDateContainer = document.createElement('div');
            startDateContainer.className = 'flex items-start mb-3';
            
            const startDateIcon = document.createElement('div');
            startDateIcon.className = 'mr-2 text-red-500';
            startDateIcon.innerHTML = `
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                </svg>
            `;
            
            const startDateLabel = document.createElement('div');
            startDateLabel.className = 'font-medium mr-2';
            startDateLabel.textContent = '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô:';
            
            const startDateText = document.createElement('div');
            const startDate = event.startDate; // Already a local Date object
            startDateText.textContent = `${startDate.getDate()} ${thaiMonths[startDate.getMonth()]} ${startDate.getFullYear() + 543}`;
            
            startDateContainer.appendChild(startDateIcon);
            startDateContainer.appendChild(startDateLabel);
            startDateContainer.appendChild(startDateText);
            modalContent.appendChild(startDateContainer);
            
            // Event end date (if exists and not the same day as start date)
            if (event.endDate && event.startDate.toDateString() !== event.endDate.toDateString()) {
                const endDateContainer = document.createElement('div');
                endDateContainer.className = 'flex items-start mb-3';
                
                const endDateIcon = document.createElement('div');
                endDateIcon.className = 'mr-2 text-red-500';
                endDateIcon.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                    </svg>
                `;
                
                const endDateLabel = document.createElement('div');
                endDateLabel.className = 'font-medium mr-2';
                endDateLabel.textContent = '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î:';
                
                const endDateText = document.createElement('div');
                const endDate = event.endDate; // Already a local Date object
                endDateText.textContent = `${endDate.getDate()} ${thaiMonths[endDate.getMonth()]} ${endDate.getFullYear() + 543}`;
                
                endDateContainer.appendChild(endDateIcon);
                endDateContainer.appendChild(endDateLabel);
                endDateContainer.appendChild(endDateText);
                modalContent.appendChild(endDateContainer);
            }
            
            // Event time
            if (event.time) {
                const timeContainer = document.createElement('div');
                timeContainer.className = 'flex items-start mb-3';
                
                const timeIcon = document.createElement('div');
                timeIcon.className = 'mr-2 text-red-500';
                timeIcon.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                `;
                
                const timeLabel = document.createElement('div');
                timeLabel.className = 'font-medium mr-2';
                timeLabel.textContent = '‡πÄ‡∏ß‡∏•‡∏≤:';
                
                const timeText = document.createElement('div');
                timeText.textContent = event.time;
                
                timeContainer.appendChild(timeIcon);
                timeContainer.appendChild(timeLabel);
                timeContainer.appendChild(timeText);
                modalContent.appendChild(timeContainer);
            }
            
            // Event location
            if (event.location) {
                const locationContainer = document.createElement('div');
                locationContainer.className = 'flex items-start mb-3';
                
                const locationIcon = document.createElement('div');
                locationIcon.className = 'mr-2 text-red-500';
                locationIcon.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
                    </svg>
                `;
                
                const locationLabel = document.createElement('div');
                locationLabel.className = 'font-medium mr-2';
                locationLabel.textContent = '‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà:';
                
                const locationText = document.createElement('div');
                locationText.textContent = event.location;
                
                locationContainer.appendChild(locationIcon);
                locationContainer.appendChild(locationLabel);
                locationContainer.appendChild(locationText);
                modalContent.appendChild(locationContainer);
            }
            
            // Related department
            if (event.department) {
                const deptContainer = document.createElement('div');
                deptContainer.className = 'flex items-start mb-3';
                
                const deptIcon = document.createElement('div');
                deptIcon.className = 'mr-2 text-red-500';
                deptIcon.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" />
                    </svg>
                `;
                
                const deptLabel = document.createElement('div');
                deptLabel.className = 'font-medium mr-2';
                deptLabel.textContent = '‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏á‡∏≤‡∏ô:';
                
                const deptText = document.createElement('div');
                deptText.textContent = event.department;
                deptText.style.color = event.color; // Set color for department in modal
                
                deptContainer.appendChild(deptIcon);
                deptContainer.appendChild(deptLabel);
                deptContainer.appendChild(deptText);
                modalContent.appendChild(deptContainer);
            }
            
            // Person in charge
            if (event.person) {
                const personContainer = document.createElement('div');
                personContainer.className = 'flex items-start mb-3';
                
                const personIcon = document.createElement('div');
                personIcon.className = 'mr-2 text-red-500';
                personIcon.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                    </svg>
                `;
                
                const personLabel = document.createElement('div');
                personLabel.className = 'font-medium mr-2';
                personLabel.textContent = '‡∏ú‡∏π‡πâ‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á:';
                
                const personText = document.createElement('div');
                personText.textContent = event.person;
                
                personContainer.appendChild(personIcon);
                personContainer.appendChild(personLabel);
                personContainer.appendChild(personText);
                modalContent.appendChild(personContainer);
            }
            
            // Event details
            if (event.details) {
                const detailsContainer = document.createElement('div');
                detailsContainer.className = 'mt-4 p-3 bg-gray-50 rounded-lg';
                
                const detailsTitle = document.createElement('h4');
                detailsTitle.className = 'font-semibold mb-2';
                detailsTitle.textContent = '‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°';
                
                const detailsText = document.createElement('p');
                detailsText.className = 'text-sm';
                detailsText.textContent = event.details;
                
                detailsContainer.appendChild(detailsTitle);
                detailsContainer.appendChild(detailsText);
                modalContent.appendChild(detailsContainer);
            }
            
            // Additional information
            if (event.additionalInfo) {
                const additionalContainer = document.createElement('div');
                additionalContainer.className = 'mt-4 p-3 bg-gray-50 rounded-lg';
                
                const additionalTitle = document.createElement('h4');
                additionalTitle.className = 'font-semibold mb-2';
                additionalTitle.textContent = '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°';
                
                const additionalText = document.createElement('p');
                additionalText.className = 'text-sm';
                additionalText.textContent = event.additionalInfo;
                
                additionalContainer.appendChild(additionalTitle);
                additionalContainer.appendChild(additionalText);
                modalContent.appendChild(additionalContainer);
            }
            
            eventModal.classList.remove('hidden'); // Show modal
        }
        
        // Hide event details modal
        function hideModal() {
            eventModal.classList.add('hidden');
        }
        
        // Show/hide loading status
        function showLoading(show) {
            if (show) {
                loadingIndicator.classList.remove('hidden');
            } else {
                loadingIndicator.classList.add('hidden');
            }
        }

        // Show error message
        function showErrorMessage(message) {
            errorText.textContent = message;
            errorMessageDiv.classList.remove('hidden');
        }

        // Hide error message
        function hideErrorMessage() {
            errorMessageDiv.classList.add('hidden');
            errorText.textContent = '';
        }
        
        // Format date to string (not currently used, but kept for future use)
        function formatDate(date) {
            if (!date) return '';
            return `${date.getDate()} ${thaiMonths[date.getMonth()]} ${date.getFullYear() + 543}`;
        }
        
        // Initialize the app when the page loads
        window.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
